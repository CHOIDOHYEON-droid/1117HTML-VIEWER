<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DLAS Viewer">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: blob: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: blob: https:; connect-src 'self' https: data: blob:; frame-src 'self' data: blob:;">
    <title>DLAS Viewer</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="file-opener.js"></script>
    <script src="capacitor.js"></script>

    <!-- Three.js ë¼ì´ë¸ŒëŸ¬ë¦¬ (0.147.0 - examples/js ì§€ì›í•˜ëŠ” ë§ˆì§€ë§‰ ë²„ì „) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.147.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.147.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.147.0/examples/js/loaders/PLYLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.147.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.147.0/examples/js/controls/TrackballControls.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Malgun Gothic', Roboto, sans-serif;
            background: #f0f0f0;
            min-height: 100vh;
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #333333;
            /* ë“œë˜ê·¸ ë°©ì§€ */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none;
            -webkit-user-drag: none;
        }

        .container {
            max-width: 600px;
            width: 100%;
        }

        .header {
            text-align: center;
            color: #333333;
            margin-bottom: 25px;
            /* ë“œë˜ê·¸ ë°©ì§€ */
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header img {
            max-width: 280px;
            width: 70%;
            height: auto;
            margin-bottom: 15px;
            /* ì´ë¯¸ì§€ ë“œë˜ê·¸ ë°©ì§€ */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-user-drag: none;
            -webkit-touch-callout: none;
            pointer-events: none;
        }

        .upload-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #e0e0e0;
            border-radius: 16px;
            padding: 40px 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .upload-box {
            border: 3px dashed #c0c8d0;
            border-radius: 16px;
            padding: 60px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: #ffffff;
            position: relative;
            overflow: hidden;
        }

        .upload-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.03);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .upload-box:hover::before {
            opacity: 1;
        }

        .upload-box:hover,
        .upload-box:active {
            border-color: #000000;
            border-style: solid;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .upload-box svg {
            width: 80px;
            height: 80px;
            margin-bottom: 24px;
            fill: #000000;
            position: relative;
            z-index: 1;
            transition: transform 0.3s ease;
        }

        .upload-box:hover svg {
            transform: scale(1.1);
        }

        .upload-box h2 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.6em;
            font-weight: 700;
            position: relative;
            z-index: 1;
            letter-spacing: -0.5px;
        }

        .upload-box p {
            color: #7f8c8d;
            font-size: 1em;
            position: relative;
            z-index: 1;
            font-weight: 500;
        }

        #fileInput {
            display: none;
        }

        .sample-section {
            margin-top: 20px;
            text-align: center;
        }

        .sample-title {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .sample-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .sample-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 0;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            width: 140px;
            text-align: center;
        }

        .sample-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        .sample-btn:active {
            transform: translateY(0);
        }

        /* ë©”ì¸ í™”ë©´ ì •ë³´ ë²„íŠ¼ */
        .main-info-btn {
            position: fixed;
            top: 50px;
            right: 20px;
            background: #f0f0f0;
            color: #333333;
            border: 1px solid #d0d0d0;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 1.2em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            padding: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .main-info-btn:hover {
            background: #e0e0e0;
            transform: scale(1.05);
        }

        .main-info-btn:active {
            transform: scale(0.95);
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 2em;
            }

            .upload-section {
                padding: 30px 20px;
            }

            .upload-box {
                padding: 50px 20px;
            }

            .main-info-btn {
                top: 45px;
                right: 15px;
                width: 32px;
                height: 32px;
                font-size: 1em;
            }
        }

        /* HTML ë·°ì–´ ì „ì²´í™”ë©´ ìŠ¤íƒ€ì¼ */
        .html-viewer-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #F5F5F5;
            z-index: 10000;
            flex-direction: column;
            /* ë“œë˜ê·¸ ë°©ì§€ */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none;
            -webkit-user-drag: none;
        }

        .html-viewer-overlay.active {
            display: flex;
        }

        /* 3D ë·°ì–´ ì „ì²´í™”ë©´ ìŠ¤íƒ€ì¼ */
        .viewer-3d-overlay {
            position: fixed;
            inset: 0;
            background: #F5F5F5;
            display: none;
            flex-direction: column;
            z-index: 10000;
        }

        .viewer-3d-overlay.active {
            display: flex;
        }

        .viewer-3d-container {
            flex: 1;
            position: relative;
        }

        .viewer-header {
            background: #F5F5F5;
            border-bottom: none;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 50px;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-user-drag: none;
            -webkit-touch-callout: none;
        }

        .viewer-title {
            font-size: 0.9em;
            color: #333333;
            font-weight: 600;
            user-select: none;
            -webkit-user-select: none;
            pointer-events: none;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .viewer-header > div {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .viewer-close {
            background: #0078d4;
            color: white;
            border: 1px solid #005a9e;
            border-radius: 3px;
            padding: 6px 15px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .viewer-close:hover {
            background: #005a9e;
        }

        .viewer-info-btn {
            background: #f0f0f0;
            color: #333333;
            border: 1px solid #d0d0d0;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 1em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            padding: 0;
        }

        .viewer-info-btn:hover {
            background: #e0e0e0;
        }

        /* ì •ë³´ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 30000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .info-modal.active {
            display: flex;
        }

        .info-modal-content {
            background: white;
            border-radius: 8px;
            max-width: 400px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            overflow-x: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            -webkit-overflow-scrolling: touch;
        }

        .info-modal-header {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }

        .info-modal-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333333;
        }

        .info-modal-close {
            background: #f0f0f0;
            border: 1px solid #d0d0d0;
            border-radius: 3px;
            padding: 5px 12px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .info-modal-close:hover {
            background: #e0e0e0;
        }

        .info-modal-body {
            padding: 15px;
            color: #333333;
            line-height: 1.5;
        }

        .info-section {
            margin-bottom: 15px;
        }

        .info-section h3 {
            font-size: 0.95em;
            font-weight: 600;
            margin-bottom: 6px;
            color: #0078d4;
        }

        .info-section p {
            margin: 4px 0;
            font-size: 0.85em;
        }

        .license-section {
            background: #f8f8f8;
            border-left: 3px solid #0078d4;
            padding: 12px;
            margin: 10px 0;
            font-size: 0.8em;
        }

        .license-section h4 {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333333;
            font-size: 0.9em;
        }

        .license-section p {
            margin: 3px 0;
            font-size: 0.8em;
        }

        .license-section pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            font-family: -apple-system, BlinkMacSystemFont, 'Malgun Gothic', sans-serif;
            font-size: 0.75em;
            color: #555555;
            line-height: 1.3;
            margin: 5px 0 15px 0;
            background: transparent;
            overflow-x: hidden;
        }

        .license-text {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.75em;
            color: #555555;
            line-height: 1.3;
        }

        .privacy-link {
            display: inline-block;
            margin-top: 8px;
            padding: 8px 16px;
            background: #0078d4;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .privacy-link:hover {
            background: #005a9e;
        }

        .viewer-iframe {
            flex: 1;
            border: none;
            width: 100%;
            /* ë“œë˜ê·¸ ë°©ì§€ */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none;
            -webkit-user-drag: none;
            pointer-events: auto;
        }

        /* ë¡œë”© í™”ë©´ ìŠ¤íƒ€ì¼ */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #FFFFFF;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            opacity: 1;
            transition: opacity 0.3s ease;
            padding: 20px;
            /* ë“œë˜ê·¸ ë°©ì§€ */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none;
            -webkit-user-drag: none;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-screen img {
            max-width: 80%;
            max-height: 80%;
            width: auto;
            height: auto;
            object-fit: contain;
            display: block;
            /* ì´ë¯¸ì§€ ë“œë˜ê·¸ ë°©ì§€ */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-user-drag: none;
            -webkit-touch-callout: none;
            pointer-events: none;
        }

        .legal-notice {
            position: absolute;
            bottom: 55px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.55em;
            color: #666666;
            text-align: center;
            width: 90%;
            max-width: none;
            line-height: 1.4;
            padding: 0;
            /* ë“œë˜ê·¸ ë°©ì§€ */
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            pointer-events: none;
        }

        .version-info {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.55em;
            color: #999999;
            text-align: center;
            white-space: nowrap;
            /* ë“œë˜ê·¸ ë°©ì§€ */
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div class="loading-screen" id="loadingScreen">
        <img src="white-logo.jpg" alt="DLAS Loading">
        <div class="legal-notice">ì´ ì•±ì€ ì¼ë°˜ì ì¸ 3D/HTML íŒŒì¼ ë·°ì–´ë¡œ, ì˜ë£Œê¸°ê¸°(ì˜ë£Œê¸°ê¸°ë²• ìƒ ì˜ë£Œê¸°ê¸°)ê°€ ì•„ë‹™ë‹ˆë‹¤.<br>ì§„ë‹¨, ì¹˜ë£Œ, ìˆ˜ìˆ  ê³„íš ë“± ì˜ë£Œ ëª©ì ì—ëŠ” ì‚¬ìš©í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.</div>
        <div class="version-info">DLAS v1.3 â“’ 2025 Dental Lab Automation Solution - All rights reserved</div>
    </div>

    <!-- HTML ë·°ì–´ ì˜¤ë²„ë ˆì´ -->
    <div class="html-viewer-overlay" id="htmlViewer">
        <div class="viewer-header">
            <span class="viewer-title" id="viewerTitle">HTML íŒŒì¼</span>
            <div>
                <button class="viewer-close" onclick="closeViewer()">ë‹«ê¸°</button>
                <button class="viewer-info-btn" onclick="openInfoModal()">â“˜</button>
            </div>
        </div>
        <iframe class="viewer-iframe" id="viewerFrame" sandbox="allow-scripts allow-same-origin allow-modals allow-forms allow-popups"></iframe>
    </div>

    <!-- ë©”ì¸ í™”ë©´ ì •ë³´ ë²„íŠ¼ -->
    <button class="main-info-btn" id="mainInfoBtn" onclick="openInfoModal()">â“˜</button>

    <div class="container">
        <div class="header">
            <img src="dlas-logo.png" alt="DLAS">
        </div>

        <div class="upload-section">
            <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M10,19L12,19V15H15L11.5,11L8,15H10V19Z"/>
                </svg>
                <h2>íŒŒì¼ ì„ íƒ</h2>
                <p>HTML, STL, PLY, OBJ íŒŒì¼ ì§€ì›</p>
            </div>
            <input type="file" id="fileInput" accept=".html,.htm,.stl,.ply,.obj" multiple>
        </div>
    </div>

    <script>
        // Capacitor ì´ˆê¸°í™” ëŒ€ê¸°
        let isNative = false;
        let App, Filesystem;
        let deferredPrompt;
        let externalFileOpened = false; // ì™¸ë¶€ íŒŒì¼ ì—´ë¦¼ í”Œë˜ê·¸

        // ì•± ì‹œì‘ ì‹œ ì™¸ë¶€ íŒŒì¼ ì—´ê¸° í”Œë˜ê·¸ ì²´í¬
        const launchFlag = localStorage.getItem('__external_file_launch');
        if (launchFlag) {
            console.log('ğŸ¯ Detected external file launch flag');
            externalFileOpened = true;
            localStorage.removeItem('__external_file_launch'); // í”Œë˜ê·¸ ì œê±°
        }

        // ë§ˆì§€ë§‰ìœ¼ë¡œ ì—´ë¦° íŒŒì¼ ì •ë³´ ì €ì¥ (ì¤‘ë³µ ë°©ì§€ìš©)
        let lastOpenedFile = { name: '', timestamp: 0 };

        // ì™¸ë¶€ íŒŒì¼ ì—´ê¸° ì‹œ ì™„ì „ ì´ˆê¸°í™” í•¨ìˆ˜ (ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ)
        window.resetAppForExternalFile = function() {
            console.log('ğŸ”„ Resetting app state for external file...');

            // 1. ëª¨ë“  localStorage ë°ì´í„° ì‚­ì œ (ì™„ì „ ì´ˆê¸°í™”)
            localStorage.clear();
            console.log('âœ… localStorage cleared');

            // 2. ë·°ì–´ ì™„ì „íˆ ë‹«ê¸°
            const viewer = document.getElementById('htmlViewer');
            const frame = document.getElementById('viewerFrame');
            if (viewer) {
                viewer.classList.remove('active');
            }
            if (frame) {
                frame.srcdoc = '';
            }
            console.log('âœ… Viewer reset');

            // 3. ë©”ì¸ í™”ë©´ ìˆ¨ê¸°ê¸°
            const container = document.querySelector('.container');
            if (container) {
                container.style.display = 'none';
            }
            console.log('âœ… Main screen hidden');

            // 4. í”Œë˜ê·¸ ì´ˆê¸°í™” (ì§€ì—­ ë³€ìˆ˜ì™€ window ê°ì²´ ëª¨ë‘ ì„¤ì •)
            externalFileOpened = true;
            window.externalFileOpened = true;
            console.log('âœ… App state reset complete');
        };

        // FileOpener ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ì¦‰ì‹œ ì‹¤í–‰)
        if (window.FileOpener) {
            window.FileOpener.addListener((data) => {
                const now = Date.now();
                console.log('ğŸ¯ File opened via FileOpener:', data.fileName);

                // IMPORTANT: ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ - ê°™ì€ íŒŒì¼ì´ 100ms ì´ë‚´ì— ë‹¤ì‹œ ì—´ë¦¬ëŠ” ê²ƒ ë°©ì§€
                if (lastOpenedFile.name === data.fileName && (now - lastOpenedFile.timestamp) < 100) {
                    console.log('â­ï¸ Skipping duplicate file open');
                    return;
                }

                // ë§ˆì§€ë§‰ íŒŒì¼ ì •ë³´ ì—…ë°ì´íŠ¸
                lastOpenedFile = { name: data.fileName, timestamp: now };

                // â­ í•µì‹¬: ì™¸ë¶€ íŒŒì¼ ì—´ê¸° ì „ì— ì•± ì™„ì „ ì´ˆê¸°í™”
                window.resetAppForExternalFile();

                // í™•ì¥ìì— ë”°ë¼ ë¶„ê¸°
                const ext = data.fileName.split('.').pop().toLowerCase();

                setTimeout(() => {
                    const encoding = data.encoding || 'text';
                    console.log('ğŸ“¦ File encoding:', encoding);

                    if (ext === 'stl' || ext === 'ply' || ext === 'obj') {
                        // 3D íŒŒì¼ ì²˜ë¦¬ (base64ë¡œ ì „ë‹¬ëœ ê²½ìš°)
                        if (typeof window.open3DFromBase64 === 'function') {
                            window.open3DFromBase64(data.content, data.fileName);
                            console.log('ğŸ–¥ï¸ 3D file opened:', data.fileName);
                        } else {
                            console.log('â³ 3D viewer not ready, waiting...');
                            // 3D ë·°ì–´ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì ì‹œ ëŒ€ê¸° í›„ ì¬ì‹œë„
                            setTimeout(() => {
                                if (typeof window.open3DFromBase64 === 'function') {
                                    window.open3DFromBase64(data.content, data.fileName);
                                } else {
                                    alert('3D ë·°ì–´ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                                }
                            }, 500);
                        }
                    } else {
                        // HTML íŒŒì¼ ì²˜ë¦¬
                        const htmlContent = encoding === 'base64' ? atob(data.content) : data.content;
                        window.openViewer(data.fileName, htmlContent);
                        console.log('ğŸ–¥ï¸ HTML file opened:', data.fileName);
                    }
                }, 50);
            });
            console.log('âœ… FileOpener listener registered');
        } else {
            console.log('âš ï¸ FileOpener not found');
        }

        // ì „ì—­ í•¨ìˆ˜ë¡œ ì™¸ë¶€ íŒŒì¼ í”Œë˜ê·¸ ì„¤ì • (Swiftì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
        window.setExternalFileFlag = function() {
            console.log('ğŸš€ setExternalFileFlag called from native');
            externalFileOpened = true;
            localStorage.setItem('__external_file_launch', 'true');
        };

        // Capacitor ë¡œë“œ í™•ì¸
        document.addEventListener('DOMContentLoaded', () => {
            if (window.Capacitor) {
                isNative = window.Capacitor.isNativePlatform();
                if (isNative) {
                    App = window.Capacitor.Plugins.App;
                    Filesystem = window.Capacitor.Plugins.Filesystem;
                    console.log('Capacitor loaded - Native platform detected');

                    // App URL ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ì™¸ë¶€ì—ì„œ íŒŒì¼ ì—´ê¸°)
                    if (App) {
                        App.addListener('appUrlOpen', (data) => {
                            console.log('ğŸ“± App URL opened:', data);
                            handleExternalFile(data);
                        });
                        console.log('âœ… App URL listener registered');
                    }
                }
            } else {
                console.log('Running in web mode');
            }
        });

        // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
            }
        }

        // HTML ë·°ì–´ ì—´ê¸°/ë‹«ê¸° (ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ)
        window.openViewer = function openViewer(fileName, htmlContent) {
            const viewer = document.getElementById('htmlViewer');
            const frame = document.getElementById('viewerFrame');
            const title = document.getElementById('viewerTitle');

            console.log('ğŸ“‚ Opening viewer for file:', fileName);

            // íŒŒì¼ëª…ì„ 20ê¸€ìë¡œ ì œí•œ
            const displayName = fileName.length > 20 ? fileName.substring(0, 20) + '...' : fileName;
            title.textContent = displayName;

            // IMPORTANT: iframe ê°•ì œ ë¦¬ì…‹ìœ¼ë¡œ ì´ì „ ë‚´ìš© ì™„ì „íˆ ì œê±°
            // ì´ë ‡ê²Œ í•˜ì§€ ì•Šìœ¼ë©´ WKWebViewì—ì„œ srcdocì´ ì œëŒ€ë¡œ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ
            frame.srcdoc = '';

            // ë“œë˜ê·¸ ë°©ì§€ ìŠ¤íƒ€ì¼ì„ HTML ì½˜í…ì¸ ì— ì£¼ì…
            const dragPreventStyle = `
                <style>
                    * {
                        user-select: none !important;
                        -webkit-user-select: none !important;
                        -moz-user-select: none !important;
                        -ms-user-select: none !important;
                        -webkit-touch-callout: none !important;
                        -webkit-user-drag: none !important;
                    }
                </style>
            `;

            // <head> íƒœê·¸ì— ìŠ¤íƒ€ì¼ ì¶”ê°€, ì—†ìœ¼ë©´ <body> ì•ì— ì¶”ê°€
            let modifiedContent = htmlContent;
            if (htmlContent.includes('</head>')) {
                modifiedContent = htmlContent.replace('</head>', dragPreventStyle + '</head>');
            } else if (htmlContent.includes('<body')) {
                modifiedContent = htmlContent.replace('<body', dragPreventStyle + '<body');
            } else {
                modifiedContent = dragPreventStyle + htmlContent;
            }

            // ê°•ì œ ë¦¬í”Œë¡œìš°ë¥¼ ìœ„í•´ ì§§ì€ ë”œë ˆì´ í›„ ìƒˆ ë‚´ìš© ì„¤ì •
            setTimeout(() => {
                frame.srcdoc = modifiedContent;
                console.log('âœ… Viewer content updated with drag prevention');
            }, 10);

            viewer.classList.add('active');

            // 1.5ì´ˆ í›„ ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê³  ë·°ì–´ í‘œì‹œ
            setTimeout(() => {
                hideLoadingScreen();
            }, 1500);
        }

        function closeViewer() {
            const viewer = document.getElementById('htmlViewer');
            const frame = document.getElementById('viewerFrame');
            const container = document.querySelector('.container');

            viewer.classList.remove('active');
            frame.srcdoc = '';

            // ì™¸ë¶€ì—ì„œ ì—´ë¦° íŒŒì¼ì„ ë‹«ì„ ë•Œ ë©”ì¸ í™”ë©´ ë‹¤ì‹œ í‘œì‹œ
            if (externalFileOpened) {
                if (container) {
                    container.style.display = 'block';
                }
                externalFileOpened = false; // í”Œë˜ê·¸ ë¦¬ì…‹
            }
        }

        // ìƒ˜í”Œ ëª¨ë¸ ë¡œë“œ í•¨ìˆ˜
        async function loadSampleModel(fileName) {
            try {
                console.log('Loading sample model:', fileName);

                // ìƒ˜í”Œ HTML íŒŒì¼ ë¡œë“œ
                const response = await fetch(fileName);
                if (!response.ok) {
                    throw new Error(`Failed to load ${fileName}`);
                }

                const htmlContent = await response.text();
                console.log('Sample model loaded successfully');

                // ë·°ì–´ì—ì„œ ì—´ê¸°
                openViewer(fileName, htmlContent);
            } catch (error) {
                console.error('Error loading sample model:', error);
                alert('ìƒ˜í”Œ ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì •ë³´ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
        function openInfoModal() {
            const modal = document.getElementById('infoModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function closeInfoModal() {
            const modal = document.getElementById('infoModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // íŒŒì¼ ì„ íƒ
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            Array.from(files).forEach(file => {
                const ext = file.name.split('.').pop().toLowerCase();
                console.log('ğŸ“‚ [ì§ì ‘ ì„ íƒ] íŒŒì¼ ì—´ê¸°:', file.name, 'í™•ì¥ì:', ext);

                // 3D íŒŒì¼ì¸ ê²½ìš°
                if (ext === 'stl' || ext === 'ply' || ext === 'obj') {
                    if (typeof window.open3DFromFile === 'function') {
                        window.open3DFromFile(file);
                    } else {
                        alert('3D ë·°ì–´ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                    return;
                }

                // HTML íŒŒì¼ì¸ ê²½ìš°
                if (ext === 'html' || ext === 'htm') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const content = e.target.result;
                        openViewer(file.name, content);
                    };
                    reader.onerror = function(e) {
                        alert('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + e.target.error);
                    };
                    reader.readAsText(file);
                    return;
                }

                // ì§€ì›í•˜ì§€ ì•ŠëŠ” í˜•ì‹
                alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤: ' + ext);
            });

            // ì…ë ¥ ì´ˆê¸°í™”
            event.target.value = '';
        }

        // â­ ìµœê·¼ íŒŒì¼ ê¸°ëŠ¥ ì™„ì „ ì œê±°ë¨
        // ëª¨ë“  íŒŒì¼(ì§ì ‘ ì„ íƒ + ì™¸ë¶€)ì„ ë™ì¼í•˜ê²Œ ì²˜ë¦¬: ë·°ì–´ì—ì„œë§Œ í‘œì‹œ, ì €ì¥ ì•ˆí•¨

        // PWA share-handlerì—ì„œ ê³µìœ ëœ íŒŒì¼ ì²˜ë¦¬
        function checkSharedFile() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('shared') === 'true') {
                const sharedData = localStorage.getItem('__shared_file');
                if (sharedData) {
                    try {
                        const data = JSON.parse(sharedData);
                        console.log('ğŸ“‚ Processing shared file:', data.name, 'type:', data.type);

                        // 5ì´ˆ ì´ë‚´ì˜ íŒŒì¼ë§Œ ì²˜ë¦¬ (ì˜¤ë˜ëœ ë°ì´í„° ë¬´ì‹œ)
                        if (Date.now() - data.timestamp < 5000) {
                            localStorage.removeItem('__shared_file');

                            if (data.type === 'html') {
                                window.openViewer(data.name, data.content);
                            } else if (data.type === '3d') {
                                // 3D ë·°ì–´ê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
                                const tryOpen3D = () => {
                                    if (typeof window.open3DFromBase64 === 'function') {
                                        window.open3DFromBase64(data.content, data.name);
                                    } else {
                                        setTimeout(tryOpen3D, 100);
                                    }
                                };
                                tryOpen3D();
                            }
                        } else {
                            localStorage.removeItem('__shared_file');
                        }
                    } catch (e) {
                        console.error('Failed to parse shared file:', e);
                        localStorage.removeItem('__shared_file');
                    }
                }
                // URLì—ì„œ shared íŒŒë¼ë¯¸í„° ì œê±°
                window.history.replaceState({}, '', '/index.html');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê³µìœ  íŒŒì¼ í™•ì¸
        checkSharedFile();

        // ì¼ë°˜ í˜ì´ì§€ ë¡œë“œ ì‹œ (ì™¸ë¶€ íŒŒì¼ ì—´ê¸°ê°€ ì•„ë‹Œ ê²½ìš°) ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
        setTimeout(() => {
            // ì™¸ë¶€ì—ì„œ íŒŒì¼ì´ ì—´ë¦° ê²½ìš° ë©”ì¸ í™”ë©´ì„ ìˆ¨ê¹€ (ë·°ì–´ë§Œ í‘œì‹œ)
            if (externalFileOpened) {
                console.log('ğŸ¯ External file opened - hiding main screen');
                const container = document.querySelector('.container');
                if (container) {
                    container.style.display = 'none';
                }
            } else {
                // ì¼ë°˜ ë¡œë“œì¸ ê²½ìš° ë¡œë”© í™”ë©´ë§Œ ìˆ¨ê¹€
                const viewer = document.getElementById('htmlViewer');
                if (!viewer.classList.contains('active')) {
                    hideLoadingScreen();
                }
            }
        }, 1500);

        // Capacitor: ì™¸ë¶€ì—ì„œ íŒŒì¼ ì—´ê¸° ì²˜ë¦¬ (ë‹¤ë¥¸ ì•±ì—ì„œ ê³µìœ ë°›ì€ íŒŒì¼)
        async function handleExternalFile(data) {
            console.log('ğŸ“± App opened with URL:', data);

            if (!data.url) {
                console.log('âŒ No URL provided');
                return;
            }

            // â­ í•µì‹¬: ì™¸ë¶€ íŒŒì¼ ì—´ê¸° ì „ì— ì•± ì™„ì „ ì´ˆê¸°í™”
            window.resetAppForExternalFile();

            try {
                // ë°©ë²• 1: fetchë¡œ ì§ì ‘ ì½ê¸° ì‹œë„ (ê°€ì¥ ê°„ë‹¨)
                const response = await fetch(data.url);
                const htmlContent = await response.text();
                const fileName = data.url.split('/').pop().split('?')[0];

                console.log('âœ… File loaded via fetch:', fileName);

                // ì´ˆê¸°í™” í›„ ë·°ì–´ì—ì„œ ë°”ë¡œ ì—´ê¸° (localStorageì— ì €ì¥í•˜ì§€ ì•ŠìŒ)
                setTimeout(() => {
                    openViewer(fileName, htmlContent);
                    console.log('ğŸ–¥ï¸ External file opened:', fileName);
                }, 50);

            } catch (fetchError) {
                console.log('âš ï¸ Fetch failed, trying Filesystem API:', fetchError);

                // ë°©ë²• 2: Filesystem API ì‚¬ìš©
                try {
                    const url = new URL(data.url);
                    let filePath = decodeURIComponent(url.pathname);

                    // iOSì˜ ê²½ìš° ê²½ë¡œ ì •ë¦¬
                    if (filePath.startsWith('/private')) {
                        filePath = filePath.substring(8);
                    }

                    console.log('ğŸ“‚ Reading file from:', filePath);

                    if (Filesystem) {
                        const content = await Filesystem.readFile({
                            path: filePath
                        });

                        const htmlContent = atob(content.data);
                        const fileName = filePath.split('/').pop();

                        console.log('âœ… File loaded via Filesystem:', fileName);

                        // ì´ˆê¸°í™” í›„ ë·°ì–´ì—ì„œ ë°”ë¡œ ì—´ê¸° (localStorageì— ì €ì¥í•˜ì§€ ì•ŠìŒ)
                        setTimeout(() => {
                            openViewer(fileName, htmlContent);
                            console.log('ğŸ–¥ï¸ External file opened:', fileName);
                        }, 50);
                    } else {
                        console.error('âŒ Filesystem API not available');
                        alert('íŒŒì¼ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Filesystem APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('âŒ All methods failed:', error);
                    alert('íŒŒì¼ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
                }
            }
        }

        // Capacitor ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        function registerCapacitorListeners() {
            if (isNative && App) {
                console.log('Registering Capacitor listeners...');

                // ì•±ì´ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¼ ë•Œ íŒŒì¼ì´ ì—´ë¦¬ëŠ” ê²½ìš°
                App.addListener('appUrlOpen', handleExternalFile);

                // ì•±ì´ ì²˜ìŒ ì‹œì‘ë  ë•Œ íŒŒì¼ê³¼ í•¨ê»˜ ì—´ë¦¬ëŠ” ê²½ìš°
                App.getLaunchUrl().then((result) => {
                    if (result && result.url) {
                        console.log('Launch URL detected:', result.url);
                        handleExternalFile(result);
                    }
                }).catch((error) => {
                    console.log('No launch URL:', error);
                });
            }
        }

        // Capacitor ë¡œë“œ í›„ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        if (window.Capacitor) {
            registerCapacitorListeners();
        } else {
            // Capacitorê°€ ë‚˜ì¤‘ì— ë¡œë“œë  ê²½ìš°ë¥¼ ëŒ€ë¹„
            window.addEventListener('load', () => {
                setTimeout(() => {
                    if (window.Capacitor) {
                        isNative = window.Capacitor.isNativePlatform();
                        if (isNative) {
                            App = window.Capacitor.Plugins.App;
                            Filesystem = window.Capacitor.Plugins.Filesystem;
                            registerCapacitorListeners();
                        }
                    }
                }, 100);
            });
        }

        // Service Worker ë“±ë¡
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }
    </script>

    <!-- ì •ë³´ ëª¨ë‹¬ -->
    <div class="info-modal" id="infoModal">
        <div class="info-modal-content">
            <div class="info-modal-header">
                <h3>ì•± ì •ë³´</h3>
                <button class="info-modal-close" onclick="closeInfoModal()">ë‹«ê¸°</button>
            </div>
            <div class="info-modal-body">
                <div class="license-section">
                    <h4>ë²„ì „ ì •ë³´</h4>
                    <p>DLAS Viewer v1.3</p>
                    <p>â“’ 2025 Dental Lab Automation Solution</p>
                </div>

                <div class="license-section">
                    <h4>ì˜¤í”ˆì†ŒìŠ¤ ë¼ì´ì„ ìŠ¤</h4>

                    <p><strong>Capacitor Core</strong></p>
                    <pre>MIT License
Copyright (c) 2017-present Ionic

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</pre>

                    <p><strong>Capacitor iOS</strong></p>
                    <pre>MIT License
Copyright (c) 2017-present Ionic

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</pre>

                    <p><strong>Capacitor Filesystem</strong></p>
                    <pre>MIT License
Copyright (c) 2017-present Ionic

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</pre>
                </div>

                <div class="license-section">
                    <a href="https://www.dlas.io/app-privacy" class="privacy-link" target="_blank">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</a>
                </div>

                <div class="license-section">
                    <h4>ìƒ˜í”Œ ëª¨ë¸</h4>
                    <div class="sample-buttons">
                        <button class="sample-btn" onclick="closeInfoModal(); loadSampleModel('sample1.html')">Sample 1 (Cube)</button>
                        <button class="sample-btn" onclick="closeInfoModal(); loadSampleModel('sample2.html')">Sample 2 (Sphere)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3D ë·°ì–´ ì˜¤ë²„ë ˆì´ -->
    <div id="viewer3DOverlay" class="viewer-3d-overlay">
        <div class="viewer-header">
            <span class="viewer-title" id="viewer3DTitle">3D íŒŒì¼</span>
            <div>
                <button class="viewer-close" onclick="close3DViewer()">ë‹«ê¸°</button>
                <button class="viewer-info-btn" onclick="openInfoModal()">â“˜</button>
            </div>
        </div>
        <div id="viewer-3d" class="viewer-3d-container"></div>
    </div>

<script>
  // ===== 3D ë·°ì–´ (ì „ì—­ THREE ì‚¬ìš©, í…ŒìŠ¤íŠ¸ìš© ì™„ì „ ë²„ì „) =====
  let renderer, scene, camera, controls;
  let viewer3DContainer = null;
  const ray = new THREE.Raycaster();
  const mouse = new THREE.Vector2();

  function show3DOverlay(title) {
    const overlay = document.getElementById('viewer3DOverlay');
    const titleEl = document.getElementById('viewer3DTitle');
    if (titleEl && title) titleEl.textContent = title;
    if (overlay) overlay.classList.add('active');

    // HTML ë·°ì–´ê°€ ì¼œì ¸ ìˆë‹¤ë©´ ë”
    const htmlOverlay = document.getElementById('htmlViewer');
    if (htmlOverlay) htmlOverlay.classList.remove('active');

    // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
    const loadingScreen = document.getElementById('loadingScreen');
    if (loadingScreen) loadingScreen.classList.add('hidden');

    // ì˜¤ë²„ë ˆì´ í‘œì‹œ í›„ controls screen ì—…ë°ì´íŠ¸
    setTimeout(function() {
      if (controls && renderer) {
        var rect = renderer.domElement.getBoundingClientRect();
        controls.screen.left = rect.left;
        controls.screen.top = rect.top;
        controls.screen.width = rect.width;
        controls.screen.height = rect.height;
      }
    }, 100);
  }

  function init3DViewer() {
    if (!viewer3DContainer) {
      viewer3DContainer = document.getElementById('viewer-3d');
    }
    if (!viewer3DContainer) {
      console.error('#viewer-3d ì»¨í…Œì´ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤.');
      throw new Error('3D ë·°ì–´ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // THREE.js ë¡œë” í™•ì¸
    if (typeof THREE === 'undefined') {
      console.error('THREE.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      throw new Error('THREE.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }
    if (typeof THREE.STLLoader === 'undefined') {
      console.error('STLLoaderê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      throw new Error('STLLoaderê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }
    if (typeof THREE.PLYLoader === 'undefined') {
      console.error('PLYLoaderê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      throw new Error('PLYLoaderê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }
    if (typeof THREE.OBJLoader === 'undefined') {
      console.error('OBJLoaderê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      throw new Error('OBJLoaderê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }

    const w = viewer3DContainer.clientWidth || window.innerWidth;
    const h = viewer3DContainer.clientHeight || window.innerHeight;
    console.log('ğŸ–¥ï¸ 3D Viewer init:', w, 'x', h);

    // ê¸°ì¡´ ë‚´ìš© ì œê±°
    viewer3DContainer.innerHTML = '';

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xF5F5F5);

    camera = new THREE.PerspectiveCamera(5, w / h, 10, 20000);
    camera.position.set(0, 0, 1000);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(w, h);
    viewer3DContainer.appendChild(renderer.domElement);

    controls = new THREE.TrackballControls(camera, renderer.domElement);
    controls.rotateSpeed = 3.0;
    controls.zoomSpeed = 1.2;
    controls.panSpeed = 0.1;
    controls.noRotate = false;
    controls.noZoom = false;
    controls.noPan = false;
    controls.staticMoving = true;
    controls.dynamicDampingFactor = 0.2;

    // ì»¨í…Œì´ë„ˆ ìœ„ì¹˜ ê¸°ë°˜ìœ¼ë¡œ screen ì„¤ì •
    var rect = renderer.domElement.getBoundingClientRect();
    controls.screen.left = rect.left;
    controls.screen.top = rect.top;
    controls.screen.width = rect.width;
    controls.screen.height = rect.height;

    // ìš°í´ë¦­ ë©”ë‰´ ë°©ì§€
    renderer.domElement.addEventListener('contextmenu', function(e) { e.preventDefault(); });

    // íœ  ê¸°ë³¸ ë™ì‘ ë°©ì§€ (ì¤Œ ì‘ë™ì„ ìœ„í•´)
    renderer.domElement.addEventListener('wheel', function(e) { e.preventDefault(); }, { passive: false });

    // ì¡°ëª…: AmbientLight + 6ë°©í–¥ DirectionalLight
    scene.add(new THREE.AmbientLight(0xffffff, 0.2));
    [
      new THREE.Vector3(1, 0, 0),
      new THREE.Vector3(-1, 0, 0),
      new THREE.Vector3(0, 1, 0),
      new THREE.Vector3(0, -1, 0),
      new THREE.Vector3(0, 0, 1),
      new THREE.Vector3(0, 0, -1)
    ].forEach(function(dir) {
      var light = new THREE.DirectionalLight(0xffffff, 0.4);
      light.position.copy(dir);
      scene.add(light);
    });

    window.addEventListener('resize', on3DWindowResize);

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    // ë§ˆìš°ìŠ¤ íœ  í´ë¦­ìœ¼ë¡œ íšŒì „ ì¤‘ì‹¬ ì„¤ì • ì´ë²¤íŠ¸ ë“±ë¡
    enableFocusEvents();

    console.log('âœ… 3D Viewer ì´ˆê¸°í™” ì™„ë£Œ');
  }

  // ë§ˆìš°ìŠ¤ íœ  í´ë¦­ìœ¼ë¡œ íšŒì „ ì¤‘ì‹¬ ì„¤ì •
  function focusToPoint(cx, cy) {
    if (!renderer || !camera || !controls) return;

    const r = renderer.domElement.getBoundingClientRect();
    mouse.x = ((cx - r.left) / r.width) * 2 - 1;
    mouse.y = -((cy - r.top) / r.height) * 2 + 1;
    ray.setFromCamera(mouse, camera);

    const hits = ray.intersectObjects(scene.children, true);
    if (!hits.length) return;

    const targetPoint = hits[0].point.clone();
    const offset = new THREE.Vector3().subVectors(camera.position, controls.target);

    // ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ ì‹œì‘/ëª©í‘œ ìœ„ì¹˜
    const startTarget = controls.target.clone();
    const endTarget = targetPoint.clone();
    const startPos = camera.position.clone();
    const endPos = endTarget.clone().add(offset);

    // ì• ë‹ˆë©”ì´ì…˜ ë³€ìˆ˜
    let animProgress = 0;
    const animDuration = 300;
    const startTime = performance.now();

    function animStep(time) {
      animProgress = Math.min((time - startTime) / animDuration, 1);

      // easeOutCubic ì´ì§• í•¨ìˆ˜ (ë¶€ë“œëŸ¬ìš´ ê°ì†)
      const eased = 1 - Math.pow(1 - animProgress, 3);

      // lerp (ì„ í˜• ë³´ê°„)
      controls.target.lerpVectors(startTarget, endTarget, eased);
      camera.position.lerpVectors(startPos, endPos, eased);
      controls.update();

      if (animProgress < 1) {
        requestAnimationFrame(animStep);
      }
    }
    requestAnimationFrame(animStep);
  }

  function enableFocusEvents() {
    if (!renderer) return;
    const dom = renderer.domElement;

    // ë§ˆìš°ìŠ¤ ì¤‘ê°„ ë²„íŠ¼(íœ  í´ë¦­)ìœ¼ë¡œ íšŒì „ ì¤‘ì‹¬ ì„¤ì •
    dom.addEventListener('mousedown', function(e) {
      if (e.button === 1) {
        e.preventDefault();
        focusToPoint(e.clientX, e.clientY);
      }
    }, false);

    // í„°ì¹˜ í™€ë“œ(ê¸¸ê²Œ ëˆ„ë¥´ê¸°)ë¡œ íšŒì „ ì¤‘ì‹¬ ì„¤ì •
    let touchTimer = null;
    let touchStartPos = null;

    dom.addEventListener('touchstart', function(e) {
      if (e.touches.length === 1) {
        touchStartPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        touchTimer = setTimeout(function() {
          if (touchStartPos) {
            focusToPoint(touchStartPos.x, touchStartPos.y);
          }
        }, 500); // 500ms í™€ë“œ
      }
    }, { passive: true });

    dom.addEventListener('touchmove', function(e) {
      // ì›€ì§ì´ë©´ íƒ€ì´ë¨¸ ì·¨ì†Œ
      if (touchTimer) {
        clearTimeout(touchTimer);
        touchTimer = null;
      }
    }, { passive: true });

    dom.addEventListener('touchend', function(e) {
      if (touchTimer) {
        clearTimeout(touchTimer);
        touchTimer = null;
      }
      touchStartPos = null;
    }, { passive: true });
  }

  function on3DWindowResize() {
    if (!viewer3DContainer || !camera || !renderer) return;
    const w = viewer3DContainer.clientWidth || window.innerWidth;
    const h = viewer3DContainer.clientHeight || window.innerHeight;
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
    renderer.setSize(w, h);
    if (controls) {
      var rect = renderer.domElement.getBoundingClientRect();
      controls.screen.left = rect.left;
      controls.screen.top = rect.top;
      controls.screen.width = rect.width;
      controls.screen.height = rect.height;
    }
  }

  function fitCameraToObject(obj) {
    const box = new THREE.Box3().setFromObject(obj);
    const size = box.getSize(new THREE.Vector3());
    const center = box.getCenter(new THREE.Vector3());

    if (!isFinite(size.x) || !isFinite(size.y) || !isFinite(size.z)) {
      console.warn('âš ï¸ bounding box ê³„ì‚° ì‹¤íŒ¨', size);
      return;
    }

    obj.position.sub(center);

    const maxDim = Math.max(size.x, size.y, size.z);
    const fov = camera.fov * (Math.PI / 180);
    let cameraZ = (maxDim / 2) / Math.tan(fov / 2);
    cameraZ *= 1.8;

    camera.position.set(0, 0, cameraZ);
    camera.near = maxDim / 100;
    camera.far = maxDim * 100;
    camera.updateProjectionMatrix();

    controls.target.set(0, 0, 0);
    controls.update();

    console.log('ğŸ“ bbox size:', size, 'cameraZ:', cameraZ);
  }

  function clear3DScene() {
    if (!scene) return;
    const toRemove = [];
    scene.traverse(obj => {
      if (obj.isMesh || obj.isGroup) toRemove.push(obj);
    });
    toRemove.forEach(obj => {
      scene.remove(obj);
      if (obj.geometry) obj.geometry.dispose();
      if (obj.material) {
        if (Array.isArray(obj.material)) obj.material.forEach(m => m.dispose());
        else obj.material.dispose();
      }
    });
  }

  // ===== File ê°ì²´ì—ì„œ ì§ì ‘ ì—´ê¸° =====
  function open3DFromFile(file) {
    const ext = file.name.split('.').pop().toLowerCase();
    console.log('ğŸ“‚ [3D] open3DFromFile', file.name, 'ext:', ext);

    // íŒŒì¼ëª… í‘œì‹œ (20ì ì œí•œ)
    const displayName = file.name.length > 20 ? file.name.substring(0, 20) + '...' : file.name;

    try {
      init3DViewer();
      clear3DScene();
      show3DOverlay(displayName);
    } catch (err) {
      console.error('âŒ 3D ë·°ì–´ ì´ˆê¸°í™” ì˜¤ë¥˜:', err);
      alert('3D ë·°ì–´ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + err.message);
      return;
    }

    const reader = new FileReader();

    reader.onerror = function(e) {
      console.error('âŒ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', e);
      alert('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    };

    // ëª¨ë“  3D íŒŒì¼ì„ ArrayBufferë¡œ í†µì¼í•˜ì—¬ ì½ê¸°
    reader.onload = e => {
      try {
        const buffer = e.target.result;
        console.log('ğŸ“¥ ArrayBuffer ê¸¸ì´:', buffer.byteLength, 'ext:', ext);

        if (ext === 'stl') {
          const loader = new THREE.STLLoader();
          const geometry = loader.parse(buffer);
          console.log('ğŸ§± STL geometry:', geometry);
          const material = new THREE.MeshPhongMaterial({ color: 0xdddddd, side: THREE.DoubleSide });
          const mesh = new THREE.Mesh(geometry, material);
          scene.add(mesh);
          fitCameraToObject(mesh);
          console.log('âœ… STL ë¡œë“œ ì™„ë£Œ');
        } else if (ext === 'ply') {
          const loader = new THREE.PLYLoader();
          const geometry = loader.parse(buffer);
          geometry.computeVertexNormals();
          console.log('ğŸ§± PLY geometry:', geometry);
          // ë²„í…ìŠ¤ ì»¬ëŸ¬ê°€ ìˆìœ¼ë©´ ì›ë³¸ ìƒ‰ìƒ ì‚¬ìš©
          let material;
          if (geometry.attributes.color) {
            material = new THREE.MeshPhongMaterial({ vertexColors: true, side: THREE.DoubleSide });
            console.log('ğŸ¨ PLY vertex colors detected');
          } else {
            material = new THREE.MeshPhongMaterial({ color: 0xdddddd, side: THREE.DoubleSide });
          }
          const mesh = new THREE.Mesh(geometry, material);
          scene.add(mesh);
          fitCameraToObject(mesh);
          console.log('âœ… PLY ë¡œë“œ ì™„ë£Œ');
        } else if (ext === 'obj') {
          // OBJëŠ” í…ìŠ¤íŠ¸ í˜•ì‹ì´ë¯€ë¡œ ArrayBufferë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
          const text = new TextDecoder().decode(new Uint8Array(buffer));
          console.log('ğŸ“¥ OBJ text length:', text.length);
          const loader = new THREE.OBJLoader();
          const obj = loader.parse(text);
          console.log('ğŸ§± OBJ object:', obj);
          // OBJì˜ ëª¨ë“  ë©”ì‹œì— ìƒ‰ìƒ ë° ì–‘ë©´ ë Œë”ë§ ì ìš©
          obj.traverse(function(child) {
            if (child.isMesh) {
              child.material = new THREE.MeshPhongMaterial({
                color: 0xdddddd,
                side: THREE.DoubleSide
              });
            }
          });
          scene.add(obj);
          fitCameraToObject(obj);
          console.log('âœ… OBJ ë¡œë“œ ì™„ë£Œ');
        }
      } catch (err) {
        console.error('âŒ 3D íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜:', err);
        alert('3D íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
      }
    };

    if (ext === 'stl' || ext === 'ply' || ext === 'obj') {
      reader.readAsArrayBuffer(file);
    } else {
      alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” 3D í˜•ì‹ì…ë‹ˆë‹¤: ' + ext);
    }
  }

  // ===== iOSì—ì„œ base64ë¡œ ë„˜ì–´ì˜¤ëŠ” ê²½ìš° =====
  function base64ToArrayBuffer(base64) {
    const binaryString = atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
  }

  function open3DFromBase64(base64, fileName) {
    const ext = fileName.split('.').pop().toLowerCase();
    console.log('ğŸ“‚ [3D] open3DFromBase64', fileName, 'ext:', ext);

    // íŒŒì¼ëª… í‘œì‹œ (20ì ì œí•œ)
    const displayName = fileName.length > 20 ? fileName.substring(0, 20) + '...' : fileName;

    try {
      init3DViewer();
      clear3DScene();
      show3DOverlay(displayName);
    } catch (err) {
      console.error('âŒ 3D ë·°ì–´ ì´ˆê¸°í™” ì˜¤ë¥˜:', err);
      alert('3D ë·°ì–´ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + err.message);
      return;
    }

    let buffer;
    try {
      buffer = base64ToArrayBuffer(base64);
      console.log('ğŸ“¥ Base64 ë³€í™˜ ì™„ë£Œ, ë²„í¼ í¬ê¸°:', buffer.byteLength);
    } catch (err) {
      console.error('âŒ Base64 ë³€í™˜ ì˜¤ë¥˜:', err);
      alert('íŒŒì¼ ë°ì´í„° ë³€í™˜ ì‹¤íŒ¨: ' + err.message);
      return;
    }

    if (ext === 'stl') {
      try {
        const loader = new THREE.STLLoader();
        const geometry = loader.parse(buffer);
        console.log('ğŸ§± STL geometry (base64):', geometry);
        const material = new THREE.MeshPhongMaterial({ color: 0xdddddd, side: THREE.DoubleSide });
        const mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);
        fitCameraToObject(mesh);
        console.log('âœ… STL ë¡œë“œ ì™„ë£Œ (base64)');
      } catch (err) {
        console.error('âŒ STL íŒŒì‹± ì˜¤ë¥˜:', err);
        alert('STL íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
      }
    } else if (ext === 'ply') {
      try {
        const loader = new THREE.PLYLoader();
        const geometry = loader.parse(buffer);
        geometry.computeVertexNormals();
        console.log('ğŸ§± PLY geometry (base64):', geometry);
        // ë²„í…ìŠ¤ ì»¬ëŸ¬ê°€ ìˆìœ¼ë©´ ì›ë³¸ ìƒ‰ìƒ ì‚¬ìš©
        let material;
        if (geometry.attributes.color) {
          material = new THREE.MeshPhongMaterial({ vertexColors: true, side: THREE.DoubleSide });
          console.log('ğŸ¨ PLY vertex colors detected');
        } else {
          material = new THREE.MeshPhongMaterial({ color: 0xdddddd, side: THREE.DoubleSide });
        }
        const mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);
        fitCameraToObject(mesh);
        console.log('âœ… PLY ë¡œë“œ ì™„ë£Œ (base64)');
      } catch (err) {
        console.error('âŒ PLY íŒŒì‹± ì˜¤ë¥˜:', err);
        alert('PLY íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
      }
    } else if (ext === 'obj') {
      try {
        const text = new TextDecoder().decode(new Uint8Array(buffer));
        console.log('ğŸ“¥ OBJ text length (base64):', text.length);
        const loader = new THREE.OBJLoader();
        const obj = loader.parse(text);
        console.log('ğŸ§± OBJ object (base64):', obj);
        // OBJì˜ ëª¨ë“  ë©”ì‹œì— ìƒ‰ìƒ ë° ì–‘ë©´ ë Œë”ë§ ì ìš©
        obj.traverse(function(child) {
          if (child.isMesh) {
            child.material = new THREE.MeshPhongMaterial({
              color: 0xdddddd,
              side: THREE.DoubleSide
            });
          }
        });
        scene.add(obj);
        fitCameraToObject(obj);
        console.log('âœ… OBJ ë¡œë“œ ì™„ë£Œ (base64)');
      } catch (err) {
        console.error('âŒ OBJ íŒŒì‹± ì˜¤ë¥˜:', err);
        alert('OBJ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
      }
    } else {
      alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” 3D í˜•ì‹ì…ë‹ˆë‹¤: ' + ext);
    }
  }

  // ===== ë‹«ê¸° =====
  window.close3DViewer = function() {
    const overlay = document.getElementById('viewer3DOverlay');
    if (overlay) overlay.classList.remove('active');

    if (scene) {
      clear3DScene();
      scene = null;
    }
    if (renderer) {
      renderer.dispose();
      renderer = null;
    }
    camera = null;
    controls = null;

    // ë©”ì¸ í™”ë©´ í‘œì‹œ
    const container = document.querySelector('.container');
    if (container) {
      container.style.display = 'block';
    }
  };

  // ì „ì—­ ë…¸ì¶œ (ê¸°ì¡´ ì½”ë“œì—ì„œ ì´ê±¸ ì‚¬ìš©ì¤‘)
  window.open3DFromFile = open3DFromFile;
  window.open3DFromBase64 = open3DFromBase64;
</script>

</body>
</html>
